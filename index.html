<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>nova</title>
  <style>
    :root {
      --bg: #0a0d12;
      --panel: #111826;
      --line: #2b3b5a;
      --text: #ffffff;
      --muted: #aeb9cf;
      --blue: #5fafff;
      --gaming-blue: #0056b3;
      --light-blue: #00a2ff;
      --bar-bg: rgba(10, 20, 35, 0.95);
      --transition-speed: 0.4s;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      width: 100%;
      height: 100%;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      overflow: hidden;
      background: radial-gradient(circle at center, #0d1b2a 0%, #010409 100%);
      color: var(--text);
    }

    #bg-canvas {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      display: block;
      pointer-events: none;
    }

    .app {
      position: relative;
      width: 100%;
      height: 100%;
      z-index: 2;
    }

    .sidebar {
      position: fixed;
      right: 24px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 14px;
      z-index: 20;
    }

    .nav-item {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: 1px solid var(--line);
      background: rgba(17, 24, 38, 0.92);
      color: var(--text);
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: border-color 0.2s ease, transform 0.2s ease, color 0.2s ease;
      backdrop-filter: blur(4px);
    }

    .icon-svg {
      width: 20px;
      height: 20px;
      display: block;
      fill: none;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .nav-item:hover,
    .nav-item.active {
      border-color: var(--blue);
      color: var(--blue);
      transform: translateX(-4px);
    }

    .view {
      display: none;
      width: 100%;
      height: 100%;
      padding: 24px 92px 24px 24px;
    }

    .view.active {
      display: flex;
      animation: viewIn 0.24s ease;
    }

    @keyframes viewIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .home {
      align-items: center;
      justify-content: center;
      flex-direction: column;
      text-align: center;
    }

    .brand {
      margin: 0;
      font-size: clamp(3.2rem, 8vw, 5.2rem);
      font-weight: 700;
      letter-spacing: -3px;
      text-transform: lowercase;
      color: #ffffff;
    }

    .message {
      margin: 6px 0 0;
      color: #ffffff;
      font-size: 1rem;
      letter-spacing: -0.2px;
    }

    .home .brand,
    .home .message {
      opacity: 0;
      transform: translateY(18px) scale(0.985);
      filter: blur(8px);
    }

    .home.play .brand {
      animation: homeReveal 0.62s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    }

    .home.play .message {
      animation: homeReveal 0.62s cubic-bezier(0.22, 1, 0.36, 1) 0.12s forwards;
    }

    @keyframes homeReveal {
      from {
        opacity: 0;
        transform: translateY(18px) scale(0.985);
        filter: blur(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
        filter: blur(0);
      }
    }

    .panel {
      width: 100%;
      height: 100%;
      border: 1px solid var(--line);
      border-radius: 16px;
      background: rgba(17, 24, 38, 0.86);
      overflow: auto;
      padding: 18px;
      backdrop-filter: blur(6px);
    }

    .panel::-webkit-scrollbar { width: 10px; }
    .panel::-webkit-scrollbar-thumb {
      background: #3b517c;
      border-radius: 999px;
    }

    .panel-tools {
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .panel-search {
      width: 100%;
      max-width: 440px;
      border: 1px solid #3c4457;
      border-radius: 999px;
      background: #10141c;
      color: #fff;
      padding: 12px 16px;
      font-size: 0.95rem;
      outline: none;
    }

    .panel-search:focus { border-color: #6f7d99; }

    .games-meta {
      width: 100%;
      text-align: center;
      color: var(--muted);
      font-size: 0.86rem;
      margin: 0;
    }

    .hot-wrap {
      width: 100%;
      max-width: 1320px;
      margin: 0 auto 16px;
      padding: 12px;
      border: 1px solid #2f446b;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(18, 28, 46, 0.85), rgba(13, 20, 34, 0.92));
    }

    .hot-title {
      font-weight: 800;
      letter-spacing: 0.04em;
      font-size: 0.95rem;
      color: #9ecbff;
      margin: 0 0 10px;
      text-transform: uppercase;
    }

    .hot-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(165px, 1fr));
      gap: 10px;
    }

    .hot-card {
      border: 1px solid #3c5789;
      background: #0f192b;
      color: #fff;
      border-radius: 12px;
      cursor: pointer;
      padding: 0;
      overflow: hidden;
      transition: transform 0.15s ease, border-color 0.2s ease;
    }

    .hot-card:hover {
      transform: translateY(-2px);
      border-color: #68bbff;
    }

    .hot-card img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      display: block;
      background: #0b111d;
    }

    .hot-card span {
      display: block;
      font-size: 0.82rem;
      font-weight: 700;
      padding: 8px;
      text-align: center;
      line-height: 1.2;
    }

    .game-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 18px;
      width: 100%;
      max-width: 1320px;
      margin: 0 auto;
      padding-bottom: 14px;
    }

    .game-card {
      width: 100%;
      max-width: 280px;
      min-height: 290px;
      justify-self: center;
      border: 1px solid var(--line);
      border-radius: 16px;
      background: #0e1523;
      overflow: hidden;
      padding: 0;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      opacity: 0;
      transform: translateY(8px) scale(0.985);
      transition: opacity 0.25s ease, transform 0.25s ease, border-color 0.2s ease;
    }

    .game-card.in {
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .game-card:hover {
      border-color: var(--blue);
      transform: translateY(0) scale(1.03);
    }

    .game-card img {
      width: 100%;
      height: 210px;
      object-fit: cover;
      object-position: center;
      display: block;
      background: #0b111d;
    }

    .game-name {
      padding: 12px 12px 14px;
      font-size: 1rem;
      line-height: 1.25;
      text-align: center;
      color: #eaf2ff;
      font-weight: 650;
      flex: 1;
      display: grid;
      place-items: center;
    }

    .sound-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
      gap: 14px;
      justify-content: stretch;
      padding-bottom: 16px;
      max-width: 1100px;
      margin: 0 auto;
    }

    .sound-btn {
      width: 100%;
      height: 118px;
      border: none;
      border-radius: 22px;
      cursor: pointer;
      color: #fff;
      display: grid;
      place-items: center;
      padding: 10px;
      font-size: 0.95rem;
      font-weight: 700;
      opacity: 0;
      transform: translateY(8px) scale(0.985);
      transition: transform 0.12s ease, opacity 0.25s ease;
    }

    .sound-btn.in {
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .sound-btn:active { transform: translateY(4px); }

    .btn-label {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-align: center;
      line-height: 1.1;
      pointer-events: none;
    }

    #player-overlay {
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transform: scale(1.015);
      transition:
        opacity 0.28s ease,
        transform 0.28s ease,
        visibility 0s linear 0.28s;
    }

    #player-overlay.open {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
      transform: scale(1);
      transition:
        opacity 0.28s ease,
        transform 0.28s ease,
        visibility 0s linear 0s;
    }

    #game-frame {
      width: 100%;
      height: 100%;
      border: none;
      background: #000;
    }

    #top-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background: var(--bar-bg);
      border-bottom: 2px solid var(--gaming-blue);
      display: flex;
      align-items: center;
      padding: 0 20px;
      box-sizing: border-box;
      z-index: 1000;
      transform: translateY(0);
      transition: transform var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    }

    #top-bar.hidden { transform: translateY(-100%); }

    .icon-group {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .icon-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--light-blue);
      border-radius: 8px;
      width: 56px;
      height: 42px;
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: all 0.2s ease;
      color: #fff;
      padding: 0;
    }

    .icon-btn svg {
      width: 26px;
      height: 26px;
      fill: currentColor;
    }

    .icon-btn:hover {
      background: var(--gaming-blue);
      transform: scale(1.05);
      box-shadow: 0 0 10px var(--light-blue);
    }

    #toggle-trigger {
      position: fixed;
      top: 60px;
      left: 20px;
      background: var(--gaming-blue);
      color: #fff;
      border: none;
      padding: 6px 16px;
      border-radius: 0 0 10px 10px;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      z-index: 999;
      transition: transform var(--transition-speed) ease;
    }

    #top-bar.hidden + #toggle-trigger { transform: translateY(-60px); }

    #game-status {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      color: #c7d3eb;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.72rem;
      background: rgba(0, 0, 0, 0.55);
      z-index: 950;
      transition: opacity 0.2s ease;
    }

    #game-status.hide {
      opacity: 0;
      pointer-events: none;
    }

    @media (max-width: 900px) {
      .view { padding: 16px 16px 90px 16px; }
      .sidebar { right: 16px; }
      .game-grid { grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 12px; }
      .game-card { min-height: 240px; max-width: none; }
      .game-card img { height: 170px; }
      .icon-btn { width: 52px; height: 40px; }
      .hot-card img { height: 90px; }
    }

    @media (max-width: 430px) {
      .game-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .sound-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
      .sound-btn { height: 96px; border-radius: 18px; font-size: 0.78rem; }
      .hot-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
  </style>
</head>
<body>
  <canvas id="bg-canvas"></canvas>

  <div class="app">
    <div class="sidebar">
      <button class="nav-item active" data-view="home" title="Home" aria-label="Home">
        <svg class="icon-svg" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 10.5 12 3l9 7.5"></path>
          <path d="M5 9.5V21h14V9.5"></path>
          <path d="M9 21v-6h6v6"></path>
        </svg>
      </button>
      <button class="nav-item" data-view="games" title="Games" aria-label="Games">
        <svg class="icon-svg" viewBox="0 0 24 24" aria-hidden="true">
          <rect x="3" y="10" width="18" height="8" rx="4"></rect>
          <path d="M8 14h4"></path>
          <path d="M10 12v4"></path>
          <circle cx="16.5" cy="13.5" r="1"></circle>
          <circle cx="18.5" cy="15.5" r="1"></circle>
        </svg>
      </button>
      <button class="nav-item" data-view="sounds" title="Sounds" aria-label="Sounds">
        <svg class="icon-svg" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M9 18V6l10-2v12"></path>
          <circle cx="6.5" cy="18.5" r="2.5"></circle>
          <circle cx="16.5" cy="16.5" r="2.5"></circle>
        </svg>
      </button>
    </div>

    <section id="home-view" class="view home active">
      <h1 class="brand">nova</h1>
      <p class="message">skyler, i know where you live</p>
    </section>

    <section id="games-view" class="view">
      <div class="panel" id="games-panel">
        <div class="panel-tools">
          <input id="games-search" class="panel-search" type="text" placeholder="Loading games..." />
          <p id="games-meta" class="games-meta"></p>
        </div>

        <div id="hot-wrap" class="hot-wrap" hidden>
          <div class="hot-title">HOT Games</div>
          <div class="hot-grid" id="hot-grid"></div>
        </div>

        <div class="game-grid" id="game-grid"></div>
      </div>
    </section>

    <section id="sounds-view" class="view">
      <div class="panel" id="sounds-panel">
        <div class="panel-tools">
          <input id="sounds-search" class="panel-search" type="text" placeholder="Search sounds..." />
        </div>
        <div class="sound-grid" id="sound-grid"></div>
      </div>
    </section>
  </div>

  <div id="player-overlay">
    <div id="top-bar">
      <div class="icon-group">
        <button class="icon-btn" id="back-home" title="Back" aria-label="Back">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
        </button>
        <button class="icon-btn" id="fullscreen-btn" title="Toggle Fullscreen" aria-label="Toggle Fullscreen">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
        </button>
      </div>
    </div>

    <button id="toggle-trigger" type="button">HIDE BAR</button>

    <div id="game-status">loading...</div>
    <iframe id="game-frame" allowfullscreen></iframe>
  </div>

  <script>
    const data = {
      games: [],
      sounds: [
        {"id":1,"name":"FAHHHHHHHHHHHHHH","url":"https://www.myinstants.com/media/sounds/fahhhhhhhhhhhhhh.mp3","keyHint":""},
        {"id":2,"name":"VINE BOOM SOUND","url":"https://www.myinstants.com/media/sounds/vine-boom.mp3","keyHint":""},
        {"id":3,"name":"Fahhh","url":"https://www.myinstants.com/media/sounds/fahhh_KcgAXfs.mp3","keyHint":""},
        {"id":4,"name":"FAAAH","url":"https://www.myinstants.com/media/sounds/faaah.mp3","keyHint":""},
        {"id":5,"name":"rizz sound effect","url":"https://www.myinstants.com/media/sounds/rizz-sound-effect.mp3","keyHint":""},
        {"id":6,"name":"Fart","url":"https://www.myinstants.com/media/sounds/dry-fart.mp3","keyHint":""},
        {"id":7,"name":"YOURE PHONE IS RINGING","url":"https://www.myinstants.com/media/sounds/youre-phone-is-ringing.mp3","keyHint":""},
        {"id":8,"name":"Among Us role reveal sound","url":"https://www.myinstants.com/media/sounds/among-us-role-reveal-sound.mp3","keyHint":""},
        {"id":9,"name":"Chicken on tree screaming","url":"https://www.myinstants.com/media/sounds/chicken-on-tree-screaming.mp3","keyHint":""},
        {"id":10,"name":"Anime Wow","url":"https://www.myinstants.com/media/sounds/anime-wow-sound-effect.mp3","keyHint":""},
        {"id":11,"name":"Hub Intro Sound","url":"https://www.myinstants.com/media/sounds/hub-intro-sound.mp3","keyHint":""},
        {"id":12,"name":"Dexter meme","url":"https://www.myinstants.com/media/sounds/dexter-meme.mp3","keyHint":""},
        {"id":13,"name":"oi oi oe oi a eye eye","url":"https://www.myinstants.com/media/sounds/oi-oi-oe-oi-a-eye-eye.mp3","keyHint":""},
        {"id":14,"name":"SpongeBob Fail","url":"https://www.myinstants.com/media/sounds/spongebob-fail.mp3","keyHint":""},
        {"id":15,"name":"Apple Pay","url":"https://www.myinstants.com/media/sounds/applepay.mp3","keyHint":""},
        {"id":16,"name":"indian song","url":"https://www.myinstants.com/media/sounds/indian-song.mp3","keyHint":""},
        {"id":17,"name":"BRUH","url":"https://www.myinstants.com/media/sounds/movie_1.mp3","keyHint":""},
        {"id":18,"name":"dun dun dunnnnnnnn","url":"https://www.myinstants.com/media/sounds/dun-dun-dun-sound-effect-brass_8nFBccR.mp3","keyHint":""},
        {"id":19,"name":"rip my granny she got hit by a bazooka","url":"https://www.myinstants.com/media/sounds/rip-my-granny-she-got-hit-by-a-bazooka.mp3","keyHint":""},
        {"id":20,"name":"gey echo","url":"https://www.myinstants.com/media/sounds/gey-echo.mp3","keyHint":""},
        {"id":21,"name":"Smoke Detector Beep","url":"https://www.myinstants.com/media/sounds/smoke-detector-beep.mp3","keyHint":""},
        {"id":22,"name":"yes!(lara voice)","url":"https://www.myinstants.com/media/sounds/yes-lara-voice.mp3","keyHint":""},
        {"id":23,"name":"Bone Crack","url":"https://www.myinstants.com/media/sounds/bone-crack.mp3","keyHint":""},
        {"id":24,"name":"romanceeeeeeeeeeeeee","url":"https://www.myinstants.com/media/sounds/romanceeeeeeeeeeeeee.mp3","keyHint":""},
        {"id":25,"name":"The Undertaker Bell","url":"https://www.myinstants.com/media/sounds/undertakers-bell_2UwFCIe.mp3","keyHint":""},
        {"id":26,"name":"We are charlie kirk loud asf","url":"https://www.myinstants.com/media/sounds/we-are-charlie-kirk-loud-asf.mp3","keyHint":""},
        {"id":27,"name":"Tuco: GET OUT","url":"https://www.myinstants.com/media/sounds/tuco-get-out.mp3","keyHint":""},
        {"id":28,"name":"ACK","url":"https://www.myinstants.com/media/sounds/ack.mp3","keyHint":""},
        {"id":29,"name":"Daddyy Chill","url":"https://www.myinstants.com/media/sounds/daddyy-chill.mp3","keyHint":""},
        {"id":30,"name":"Fart Button","url":"https://www.myinstants.com/media/sounds/perfect-fart.mp3","keyHint":""}
      ]
    };

    const MANUAL_GAMES = [
      {
        id: 0,
        slug: "five-nights-at-epsteins",
        name: "Five Nights At Epstein's",
        sourcePage: "https://dmsss69.itch.io/fdsfdsfdf",
        embedUrl: "https://dmsss69.itch.io/fdsfdsfdf",
        fileUrl: "",
        icon: "https://img.itch.zone/aW1nLzI0NTkxMDM1LnBuZw==/original/FsMWrt.png"
      }
    ];

    const HOT_GAME_TOKENS = [
      "five nights at epsteins",
      "run 3",
      "1v1 lol",
      "basketball stars",
      "cookie clicker",
      "minecraft"
    ];

    const views = {
      home: document.getElementById("home-view"),
      games: document.getElementById("games-view"),
      sounds: document.getElementById("sounds-view")
    };

    const homeView = document.getElementById("home-view");
    const navItems = Array.from(document.querySelectorAll(".nav-item"));
    const gameGrid = document.getElementById("game-grid");
    const soundGrid = document.getElementById("sound-grid");
    const hotWrap = document.getElementById("hot-wrap");
    const hotGrid = document.getElementById("hot-grid");

    const gamesPanel = document.getElementById("games-panel");
    const soundsPanel = document.getElementById("sounds-panel");
    const gamesSearch = document.getElementById("games-search");
    const soundsSearch = document.getElementById("sounds-search");
    const gamesMeta = document.getElementById("games-meta");

    const overlay = document.getElementById("player-overlay");
    const frame = document.getElementById("game-frame");
    const gameStatus = document.getElementById("game-status");

    const topBar = document.getElementById("top-bar");
    const toggleTrigger = document.getElementById("toggle-trigger");
    const backHomeBtn = document.getElementById("back-home");
    const fullscreenBtn = document.getElementById("fullscreen-btn");

    // Background canvas
    const bgCanvas = document.getElementById("bg-canvas");
    const bgCtx = bgCanvas.getContext("2d");
    let bgParticles = [];
    const bgMouse = { x: null, y: null, radius: 180 };

    let gameObserver = null;
    let soundObserver = null;
    let gameOpenToken = 0;
    let closeOverlayTimer = 0;
    const OVERLAY_ANIM_MS = 280;
    const players = new Map();

    function norm(value) {
      return (value || "").toLowerCase().trim();
    }

    function canon(value) {
      return norm(value).replace(/[^a-z0-9]+/g, "");
    }

    function slugify(value) {
      return norm(value).replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "") || "game";
    }

    function uniqueGames(list) {
      const source = Array.isArray(list) ? list : [];
      const seenByName = new Set();
      const seenByUrl = new Set();
      const unique = [];

      for (const game of source) {
        const name = (game?.name || "untitled game").trim();
        const sourcePage = game?.sourcePage || game?.embedUrl || "";
        const embedUrl = game?.embedUrl || sourcePage;
        const fileUrl = game?.fileUrl || "";
        const icon = game?.icon || "";
        const slug = game?.slug || slugify(name);

        const nameKey = canon(name);
        const urlKey = norm(embedUrl || sourcePage);

        if ((nameKey && seenByName.has(nameKey)) || (urlKey && seenByUrl.has(urlKey))) continue;

        if (nameKey) seenByName.add(nameKey);
        if (urlKey) seenByUrl.add(urlKey);

        unique.push({
          id: 0,
          slug,
          name,
          sourcePage,
          embedUrl,
          fileUrl,
          icon
        });
      }

      return unique.map((game, idx) => ({ ...game, id: idx + 1 }));
    }

    function toAbsolute(base, path) {
      if (!path) return "";
      try { return new URL(path, base).href; } catch { return ""; }
    }

    async function fetchJson(url, timeoutMs = 25000) {
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), timeoutMs);
      try {
        const res = await fetch(url, { cache: "no-store", signal: controller.signal });
        if (!res.ok) return null;
        return await res.json();
      } catch {
        return null;
      } finally {
        clearTimeout(timer);
      }
    }

    function mapSeleniteGames(feed) {
      if (!Array.isArray(feed)) return [];
      return feed
        .filter((item) => item && item.name && item.directory)
        .map((item) => {
          const dir = String(item.directory).replace(/^\/+/, "");
          const link = toAbsolute("https://selenite-copy.pages.dev/", dir + "/index.html");
          const icon = toAbsolute("https://selenite-copy.pages.dev/", dir + "/" + (item.image || "icon.png"));
          return {
            id: 0,
            slug: slugify(item.name),
            name: item.name,
            sourcePage: link,
            embedUrl: link,
            fileUrl: "",
            icon
          };
        });
    }

    function map1kh0Games(feed) {
      if (!Array.isArray(feed)) return [];
      return feed
        .filter((item) => item && item.title && item.link)
        .map((item) => ({
          id: 0,
          slug: slugify(item.title),
          name: item.title,
          sourcePage: toAbsolute("https://1kh0.github.io/", item.link),
          embedUrl: toAbsolute("https://1kh0.github.io/", item.link),
          fileUrl: "",
          icon: toAbsolute("https://1kh0.github.io/", item.imgSrc || "")
        }));
    }

    let allGames = uniqueGames(data.games);
    const allSounds = Array.isArray(data.sounds) ? data.sounds : [];

    function playHomeAnimation() {
      homeView.classList.remove("play");
      void homeView.offsetWidth;
      homeView.classList.add("play");
    }

    function setView(nextView) {
      Object.entries(views).forEach(([name, node]) => {
        node.classList.toggle("active", name === nextView);
      });

      navItems.forEach((item) => {
        item.classList.toggle("active", item.dataset.view === nextView);
      });

      if (nextView === "games") requestAnimationFrame(() => wireObserver(gamesPanel, ".game-card", "game"));
      if (nextView === "sounds") requestAnimationFrame(() => wireObserver(soundsPanel, ".sound-btn", "sound"));
      if (nextView === "home") playHomeAnimation();
    }

    navItems.forEach((item) => {
      item.addEventListener("click", () => setView(item.dataset.view));
    });

    function wireObserver(rootNode, selector, kind) {
      const prev = kind === "game" ? gameObserver : soundObserver;
      if (prev) prev.disconnect();

      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          entry.target.classList.toggle("in", entry.intersectionRatio >= 0.12);
        });
      }, {
        root: rootNode,
        threshold: [0, 0.12, 0.24, 0.5, 0.8, 1]
      });

      rootNode.querySelectorAll(selector).forEach((node) => observer.observe(node));

      if (kind === "game") gameObserver = observer;
      if (kind === "sound") soundObserver = observer;
    }

    function getFallbackGameIcon(game) {
      const target = game.sourcePage || game.embedUrl || "";
      if (!target) return "";
      return "https://www.google.com/s2/favicons?sz=256&domain_url=" + encodeURIComponent(target);
    }

    function renderGames(list) {
      gameGrid.innerHTML = "";
      const fragment = document.createDocumentFragment();

      list.forEach((game) => {
        const button = document.createElement("button");
        button.type = "button";
        button.className = "game-card";
        button.title = game.name;
        button.setAttribute("aria-label", game.name);

        const image = document.createElement("img");
        const fallbackIcon = getFallbackGameIcon(game);
        image.src = game.icon || fallbackIcon;
        image.alt = game.name;
        image.loading = "lazy";
        image.decoding = "async";
        image.referrerPolicy = "no-referrer";
        image.addEventListener("error", () => {
          if (fallbackIcon && image.src !== fallbackIcon) image.src = fallbackIcon;
        });

        const name = document.createElement("div");
        name.className = "game-name";
        name.textContent = game.name;

        button.appendChild(image);
        button.appendChild(name);
        button.addEventListener("click", () => openGame(game));
        fragment.appendChild(button);
      });

      gameGrid.appendChild(fragment);
      wireObserver(gamesPanel, ".game-card", "game");
    }

    function renderSounds(list) {
      soundGrid.innerHTML = "";
      const fragment = document.createDocumentFragment();

      const colors = [
        { main: "#ff5f5f", shadow: "#c44545" },
        { main: "#5fafff", shadow: "#4585c4" },
        { main: "#5fff7d", shadow: "#45c45e" },
        { main: "#ffdf5f", shadow: "#c4ab45" },
        { main: "#af5fff", shadow: "#8045c4" }
      ];

      list.forEach((sound, index) => {
        const button = document.createElement("button");
        button.type = "button";
        button.className = "sound-btn";
        button.setAttribute("aria-label", sound.name || "sound");

        const color = colors[index % colors.length];
        button.style.backgroundColor = color.main;
        button.style.boxShadow = "0 8px 0 " + color.shadow + ", 0 15px 20px rgba(0,0,0,0.12)";
        button.innerHTML = '<span class="btn-label">' + (sound.name || "sound") + "</span>";
        button.addEventListener("click", () => playSound(sound.url));

        fragment.appendChild(button);
      });

      soundGrid.appendChild(fragment);
      wireObserver(soundsPanel, ".sound-btn", "sound");
    }

    function findGameByToken(token) {
      const t = canon(token);
      return allGames.find((g) => {
        const n = canon(g.name);
        return n === t || n.includes(t) || t.includes(n);
      });
    }

    function renderHotGames() {
      hotGrid.innerHTML = "";

      const picked = [];
      const used = new Set();

      for (const token of HOT_GAME_TOKENS) {
        const g = findGameByToken(token);
        if (!g || used.has(g.id)) continue;
        used.add(g.id);
        picked.push(g);
      }

      for (const g of allGames) {
        if (picked.length >= 8) break;
        if (used.has(g.id)) continue;
        used.add(g.id);
        picked.push(g);
      }

      if (!picked.length) {
        hotWrap.hidden = true;
        return;
      }

      const frag = document.createDocumentFragment();

      picked.forEach((game) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "hot-card";
        btn.setAttribute("aria-label", game.name);
        btn.title = game.name;

        const img = document.createElement("img");
        const fallbackIcon = getFallbackGameIcon(game);
        img.src = game.icon || fallbackIcon;
        img.alt = game.name;
        img.loading = "lazy";
        img.addEventListener("error", () => {
          if (fallbackIcon && img.src !== fallbackIcon) img.src = fallbackIcon;
        });

        const label = document.createElement("span");
        label.textContent = game.name;

        btn.appendChild(img);
        btn.appendChild(label);
        btn.addEventListener("click", () => openGame(game));
        frag.appendChild(btn);
      });

      hotGrid.appendChild(frag);
      hotWrap.hidden = false;
    }

    function applyGamesFilter() {
      const query = norm(gamesSearch.value);
      const filtered = query ? allGames.filter((game) => norm(game.name).includes(query)) : allGames;
      gamesMeta.textContent = filtered.length + " / " + allGames.length + " games";
      renderGames(filtered);
      gamesPanel.scrollTop = 0;

      hotWrap.hidden = query.length > 0;
      if (!query.length) renderHotGames();
    }

    function applySoundsFilter() {
      const query = norm(soundsSearch.value);
      const filtered = query ? allSounds.filter((sound) => norm(sound.name).includes(query)) : allSounds;
      renderSounds(filtered);
      soundsPanel.scrollTop = 0;
    }

    function getPlayer(url) {
      if (!players.has(url)) {
        const audio = new Audio(url);
        audio.preload = "none";
        players.set(url, audio);
      }
      return players.get(url);
    }

    function playSound(url) {
      if (!url) return;
      const audio = getPlayer(url);
      audio.currentTime = 0;
      audio.play().catch(() => {});
    }

    function showStatus(text) {
      gameStatus.textContent = text;
      gameStatus.classList.remove("hide");
    }

    function hideStatus() {
      gameStatus.classList.add("hide");
    }

    function resetTopBar() {
      topBar.classList.remove("hidden");
      toggleTrigger.textContent = "HIDE BAR";
    }

    function toggleBar() {
      if (topBar.classList.contains("hidden")) {
        topBar.classList.remove("hidden");
        toggleTrigger.textContent = "HIDE BAR";
      } else {
        topBar.classList.add("hidden");
        toggleTrigger.textContent = "SHOW BAR";
      }
    }

    async function tryFrameLoad(url, token) {
      return await new Promise((resolve) => {
        let done = false;

        const finish = (ok) => {
          if (done) return;
          done = true;
          frame.onload = null;
          frame.onerror = null;
          clearTimeout(timer);
          resolve(ok);
        };

        const timer = setTimeout(() => finish(false), 10000);

        frame.onload = () => {
          if (token !== gameOpenToken) return finish(false);
          try {
            const href = frame.contentWindow && frame.contentWindow.location ? frame.contentWindow.location.href : "";
            if (href === "about:blank" || href.startsWith("chrome-error://") || href.startsWith("edge-error://")) {
              return finish(false);
            }
          } catch {
            // Cross-origin loaded
          }
          finish(true);
        };

        frame.onerror = () => finish(false);
        frame.src = url;
      });
    }

    async function openGame(game) {
      const token = ++gameOpenToken;

      clearTimeout(closeOverlayTimer);
      overlay.classList.add("open");
      resetTopBar();
      showStatus("loading...");
      frame.src = "about:blank";

      const attempts = [game.embedUrl, game.sourcePage]
        .filter(Boolean)
        .filter((v, i, arr) => arr.indexOf(v) === i);

      for (const candidate of attempts) {
        if (token !== gameOpenToken) return;
        const ok = await tryFrameLoad(candidate, token);
        if (token !== gameOpenToken) return;
        if (ok) {
          hideStatus();
          return;
        }
      }

      showStatus("blocked in iframe");
    }

    function closeGame() {
      gameOpenToken += 1;
      hideStatus();
      resetTopBar();
      overlay.classList.remove("open");

      clearTimeout(closeOverlayTimer);
      closeOverlayTimer = setTimeout(() => {
        frame.src = "about:blank";
        setView("games");
      }, OVERLAY_ANIM_MS);
    }

    async function loadExternalGames() {
      gamesSearch.placeholder = "Loading games...";
      gamesMeta.textContent = "Fetching from both sources...";

      const [seleniteRaw, kh0Raw] = await Promise.all([
        fetchJson("https://selenite-copy.pages.dev/games.json"),
        fetchJson("https://1kh0.github.io/config/games.json")
      ]);

      const merged = [
        ...MANUAL_GAMES,
        ...mapSeleniteGames(seleniteRaw),
        ...map1kh0Games(kh0Raw)
      ];

      allGames = uniqueGames(merged);
      applyGamesFilter();

      gamesSearch.placeholder = "Search games... (" + allGames.length + ")";
    }

    function initBackground() {
      bgCanvas.width = window.innerWidth;
      bgCanvas.height = window.innerHeight;

      bgParticles = [];
      const count = (bgCanvas.width * bgCanvas.height) / 11000;
      for (let i = 0; i < count; i += 1) {
        bgParticles.push({
          x: Math.random() * bgCanvas.width,
          y: Math.random() * bgCanvas.height,
          size: Math.random() * 1.5 + 0.5,
          vx: (Math.random() - 0.5) * 0.4,
          vy: (Math.random() - 0.5) * 0.4
        });
      }
    }

    function updateBackground() {
      bgCtx.fillStyle = "rgba(1, 4, 9, 0.15)";
      bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);

      for (let i = 0; i < bgParticles.length; i += 1) {
        const p = bgParticles[i];

        p.x += p.vx;
        p.y += p.vy;

        if (p.x > bgCanvas.width) p.x = 0;
        if (p.x < 0) p.x = bgCanvas.width;
        if (p.y > bgCanvas.height) p.y = 0;
        if (p.y < 0) p.y = bgCanvas.height;

        if (bgMouse.x != null) {
          const dx = bgMouse.x - p.x;
          const dy = bgMouse.y - p.y;
          const distance = Math.sqrt(dx * dx + dy * dy);

          if (distance < bgMouse.radius) {
            const force = (bgMouse.radius - distance) / bgMouse.radius;
            p.x -= (dx / 50) * force;
            p.y -= (dy / 50) * force;
          }
        }

        bgCtx.fillStyle = "rgba(100, 210, 255, 0.8)";
        bgCtx.beginPath();
        bgCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        bgCtx.fill();
      }

      for (let a = 0; a < bgParticles.length; a += 1) {
        for (let b = a + 1; b < bgParticles.length; b += 1) {
          const dx = bgParticles[a].x - bgParticles[b].x;
          const dy = bgParticles[a].y - bgParticles[b].y;
          const distance = Math.sqrt(dx * dx + dy * dy);

          if (distance < 150) {
            const opacity = 1 - distance / 150;
            bgCtx.strokeStyle = "rgba(100, 210, 255, " + (opacity * 0.2) + ")";
            bgCtx.lineWidth = 0.8;
            bgCtx.beginPath();
            bgCtx.moveTo(bgParticles[a].x, bgParticles[a].y);
            bgCtx.lineTo(bgParticles[b].x, bgParticles[b].y);
            bgCtx.stroke();
          }
        }
      }

      requestAnimationFrame(updateBackground);
    }

    window.addEventListener("mousemove", (e) => {
      bgMouse.x = e.clientX;
      bgMouse.y = e.clientY;
    });

    window.addEventListener("mouseout", () => {
      bgMouse.x = null;
      bgMouse.y = null;
    });

    window.addEventListener("resize", initBackground);

    backHomeBtn.addEventListener("click", closeGame);
    toggleTrigger.addEventListener("click", toggleBar);

    fullscreenBtn.addEventListener("click", () => {
      if (document.fullscreenElement) {
        document.exitFullscreen().catch(() => {});
      } else {
        overlay.requestFullscreen().catch(() => {});
      }
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && overlay.classList.contains("open")) {
        closeGame();
      }
    });

    gamesSearch.addEventListener("input", applyGamesFilter);
    soundsSearch.addEventListener("input", applySoundsFilter);

    applyGamesFilter();
    applySoundsFilter();
    loadExternalGames();
    requestAnimationFrame(playHomeAnimation);
    initBackground();
    updateBackground();
  </script>
</body>
</html>
