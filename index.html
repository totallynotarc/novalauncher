<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>nova</title>
  <style>
    :root {
      --bg: #0a0d12;
      --panel: #111826;
      --line: #2b3b5a;
      --text: #ffffff;
      --muted: #aeb9cf;
      --blue: #5fafff;
      --blue-2: #4585c4;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      width: 100%;
      height: 100%;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow: hidden;
    }

    .app {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .sidebar {
      position: fixed;
      right: 24px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 14px;
      z-index: 20;
    }

    .nav-item {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: 1px solid var(--line);
      background: var(--panel);
      color: var(--text);
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: border-color 0.2s ease, transform 0.2s ease, color 0.2s ease;
    }

    .icon-svg {
      width: 20px;
      height: 20px;
      display: block;
      fill: none;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .nav-item:hover,
    .nav-item.active {
      border-color: var(--blue);
      color: var(--blue);
      transform: translateX(-4px);
    }

    .view {
      display: none;
      width: 100%;
      height: 100%;
      padding: 24px 92px 24px 24px;
    }

    .view.active { display: flex; }

    .home {
      align-items: center;
      justify-content: center;
      flex-direction: column;
      text-align: center;
    }

    .brand {
      margin: 0;
      font-size: clamp(3.2rem, 8vw, 5.2rem);
      font-weight: 700;
      letter-spacing: -3px;
      text-transform: lowercase;
      color: #ffffff;
    }

    .message {
      margin: 6px 0 0;
      color: #ffffff;
      font-size: 1rem;
      letter-spacing: -0.2px;
    }

    .panel {
      width: 100%;
      height: 100%;
      border: 1px solid var(--line);
      border-radius: 16px;
      background: var(--panel);
      overflow: auto;
      padding: 18px;
    }

    .panel::-webkit-scrollbar { width: 10px; }
    .panel::-webkit-scrollbar-thumb {
      background: #3b517c;
      border-radius: 999px;
    }

    .panel-tools {
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .panel-search {
      width: 100%;
      max-width: 420px;
      border: 1px solid #3c4457;
      border-radius: 999px;
      background: #10141c;
      color: #fff;
      padding: 12px 16px;
      font-size: 0.95rem;
      outline: none;
    }

    .panel-search:focus { border-color: #6f7d99; }

    .games-meta {
      width: 100%;
      text-align: center;
      color: var(--muted);
      font-size: 0.85rem;
      margin: 0;
    }

    .game-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
      gap: 18px;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding-bottom: 14px;
    }

    .game-card {
      width: 100%;
      max-width: 240px;
      min-height: 250px;
      justify-self: center;
      border: 1px solid var(--line);
      border-radius: 16px;
      background: #0e1523;
      overflow: hidden;
      padding: 0;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      opacity: 0;
      transform: translateY(8px) scale(0.985);
      transition: opacity 0.25s ease, transform 0.25s ease, border-color 0.2s ease;
    }

    .game-card.in {
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .game-card:hover {
      border-color: var(--blue);
      transform: translateY(0) scale(1.03);
    }

    .game-card img {
      width: 100%;
      height: 185px;
      object-fit: cover;
      object-position: center;
      display: block;
      background: #0b111d;
    }

    .game-name {
      padding: 12px 12px 14px;
      font-size: 0.96rem;
      line-height: 1.25;
      text-align: center;
      color: #eaf2ff;
      font-weight: 600;
      flex: 1;
      display: grid;
      place-items: center;
    }

    .sound-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
      gap: 14px;
      justify-content: stretch;
      padding-bottom: 16px;
      max-width: 1100px;
      margin: 0 auto;
    }

    .sound-btn {
      width: 100%;
      height: 118px;
      border: none;
      border-radius: 22px;
      cursor: pointer;
      color: #fff;
      display: grid;
      place-items: center;
      padding: 10px;
      font-size: 0.95rem;
      font-weight: 700;
      opacity: 0;
      transform: translateY(8px) scale(0.985);
      transition: transform 0.12s ease, opacity 0.25s ease;
    }

    .sound-btn.in {
      opacity: 1;
      transform: translateY(0) scale(1);
    }

    .sound-btn:active { transform: translateY(4px); }

    .btn-label {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-align: center;
      line-height: 1.1;
      pointer-events: none;
    }

    #player-overlay {
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 100;
      display: none;
    }

    #game-frame {
      width: 100%;
      height: 100%;
      border: none;
      background: #000;
    }

    /* Black floating taskbar */
    .player-top {
      position: absolute;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 101;
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(0, 0, 0, 0.96);
      border: 1px solid #222;
      border-radius: 16px;
      padding: 10px;
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(2px);
    }

    /* Bigger control buttons */
    .player-btn {
      border: 1px solid #3c4f78;
      background: #111826;
      color: #fff;
      border-radius: 12px;
      width: 68px;
      height: 56px;
      cursor: pointer;
      display: grid;
      place-items: center;
      transition: border-color 0.2s ease, transform 0.15s ease;
    }

    .player-btn .icon-svg {
      width: 24px;
      height: 24px;
    }

    .player-btn:hover {
      border-color: var(--blue);
      transform: translateY(-1px);
    }

    #game-status {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      color: #c7d3eb;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.72rem;
      background: rgba(0, 0, 0, 0.55);
      z-index: 102;
    }

    #game-status.hide {
      opacity: 0;
      pointer-events: none;
    }

    @media (max-width: 900px) {
      .view { padding: 16px 16px 90px 16px; }
      .sidebar { right: 16px; }
      .game-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
      .game-card { min-height: 220px; max-width: none; }
      .game-card img { height: 160px; }
      .player-top { top: 10px; }
      .player-btn { width: 62px; height: 52px; }
    }

    @media (max-width: 430px) {
      .game-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .sound-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
      .sound-btn { height: 96px; border-radius: 18px; font-size: 0.78rem; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar">
      <button class="nav-item active" data-view="home" title="Home" aria-label="Home">
        <svg class="icon-svg" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 10.5 12 3l9 7.5"></path>
          <path d="M5 9.5V21h14V9.5"></path>
          <path d="M9 21v-6h6v6"></path>
        </svg>
      </button>
      <button class="nav-item" data-view="games" title="Games" aria-label="Games">
        <svg class="icon-svg" viewBox="0 0 24 24" aria-hidden="true">
          <rect x="3" y="10" width="18" height="8" rx="4"></rect>
          <path d="M8 14h4"></path>
          <path d="M10 12v4"></path>
          <circle cx="16.5" cy="13.5" r="1"></circle>
          <circle cx="18.5" cy="15.5" r="1"></circle>
        </svg>
      </button>
      <button class="nav-item" data-view="sounds" title="Sounds" aria-label="Sounds">
        <svg class="icon-svg" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M9 18V6l10-2v12"></path>
          <circle cx="6.5" cy="18.5" r="2.5"></circle>
          <circle cx="16.5" cy="16.5" r="2.5"></circle>
        </svg>
      </button>
    </div>

    <section id="home-view" class="view home active">
      <h1 class="brand">nova</h1>
      <p class="message">skyler, i know where you live</p>
    </section>

    <section id="games-view" class="view">
      <div class="panel" id="games-panel">
        <div class="panel-tools">
          <input id="games-search" class="panel-search" type="text" placeholder="Loading games..." />
          <p id="games-meta" class="games-meta"></p>
        </div>
        <div class="game-grid" id="game-grid"></div>
      </div>
    </section>

    <section id="sounds-view" class="view">
      <div class="panel" id="sounds-panel">
        <div class="panel-tools">
          <input id="sounds-search" class="panel-search" type="text" placeholder="Search sounds..." />
        </div>
        <div class="sound-grid" id="sound-grid"></div>
      </div>
    </section>
  </div>

  <div id="player-overlay">
    <div class="player-top" role="toolbar" aria-label="Game controls">
      <button class="player-btn" id="back-home" title="Back" aria-label="Back">
        <svg class="icon-svg" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M15 18 9 12l6-6"></path>
        </svg>
      </button>
      <button class="player-btn" id="fullscreen-btn" title="Fullscreen" aria-label="Fullscreen">
        <svg class="icon-svg" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M4 9V4h5"></path>
          <path d="M20 9V4h-5"></path>
          <path d="M4 15v5h5"></path>
          <path d="M20 15v5h-5"></path>
        </svg>
      </button>
    </div>
    <div id="game-status">loading...</div>
    <iframe id="game-frame" allowfullscreen></iframe>
  </div>

  <script>
    const data = {
      games: [],
      sounds: [
        { id: 1, name: "VINE BOOM SOUND", url: "https://www.myinstants.com/media/sounds/vine-boom.mp3" },
        { id: 2, name: "Discord Notification", url: "https://www.myinstants.com/media/sounds/discord-notification.mp3" },
        { id: 3, name: "ROBLOX oof", url: "https://www.myinstants.com/media/sounds/roblox-death-sound_1.mp3" },
        { id: 4, name: "Metal pipe clang", url: "https://www.myinstants.com/media/sounds/metal-pipe-clang.mp3" },
        { id: 5, name: "FNAF Jumpscare Scream", url: "https://www.myinstants.com/media/sounds/five-nights-at-freddys-full-scream-sound_2.mp3" }
      ]
    };

    const EXTERNAL_GAME_FEEDS = [
      { kind: "selenite", url: "https://selenite-copy.pages.dev/games.json", base: "https://selenite-copy.pages.dev/" },
      { kind: "1kh0", url: "https://1kh0.github.io/config/games.json", base: "https://1kh0.github.io/" }
    ];

    const views = {
      home: document.getElementById("home-view"),
      games: document.getElementById("games-view"),
      sounds: document.getElementById("sounds-view")
    };

    const navItems = Array.from(document.querySelectorAll(".nav-item"));
    const gameGrid = document.getElementById("game-grid");
    const soundGrid = document.getElementById("sound-grid");
    const gamesPanel = document.getElementById("games-panel");
    const soundsPanel = document.getElementById("sounds-panel");
    const gamesSearch = document.getElementById("games-search");
    const soundsSearch = document.getElementById("sounds-search");
    const gamesMeta = document.getElementById("games-meta");
    const overlay = document.getElementById("player-overlay");
    const frame = document.getElementById("game-frame");
    const gameStatus = document.getElementById("game-status");
    const backHomeBtn = document.getElementById("back-home");
    const fullscreenBtn = document.getElementById("fullscreen-btn");

    const players = new Map();
    let gameObserver = null;
    let soundObserver = null;
    let gameOpenToken = 0;

    function norm(value) {
      return (value || "").toLowerCase().trim();
    }

    function slugify(value) {
      return norm(value).replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "") || "game";
    }

    function canonicalName(value) {
      return norm(value).replace(/[^a-z0-9]+/g, "");
    }

    function uniqueGames(list) {
      const source = Array.isArray(list) ? list : [];
      const seenByName = new Set();
      const seenByUrl = new Set();
      const unique = [];

      for (const game of source) {
        const name = (game?.name || "untitled game").trim();
        const sourcePage = game?.sourcePage || game?.embedUrl || "";
        const embedUrl = game?.embedUrl || sourcePage;
        const fileUrl = game?.fileUrl || "";
        const icon = game?.icon || "";
        const slug = game?.slug || slugify(name);

        const nameKey = canonicalName(name);
        const urlKey = norm(embedUrl || sourcePage);

        if ((nameKey && seenByName.has(nameKey)) || (urlKey && seenByUrl.has(urlKey))) {
          continue;
        }

        if (nameKey) seenByName.add(nameKey);
        if (urlKey) seenByUrl.add(urlKey);

        unique.push({
          id: 0,
          slug,
          name,
          sourcePage,
          embedUrl,
          fileUrl,
          icon
        });
      }

      return unique.map((game, idx) => ({ ...game, id: idx + 1 }));
    }

    let allGames = uniqueGames(data.games);
    const allSounds = Array.isArray(data.sounds) ? data.sounds : [];

    function setView(nextView) {
      Object.entries(views).forEach(([name, node]) => {
        node.classList.toggle("active", name === nextView);
      });

      navItems.forEach((item) => {
        item.classList.toggle("active", item.dataset.view === nextView);
      });

      if (nextView === "games") {
        requestAnimationFrame(() => wireObserver(gamesPanel, ".game-card", "game"));
      }

      if (nextView === "sounds") {
        requestAnimationFrame(() => wireObserver(soundsPanel, ".sound-btn", "sound"));
      }
    }

    navItems.forEach((item) => {
      item.addEventListener("click", () => setView(item.dataset.view));
    });

    function wireObserver(rootNode, selector, kind) {
      const prev = kind === "game" ? gameObserver : soundObserver;
      if (prev) prev.disconnect();

      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          entry.target.classList.toggle("in", entry.intersectionRatio >= 0.12);
        });
      }, {
        root: rootNode,
        threshold: [0, 0.12, 0.24, 0.5, 0.8, 1]
      });

      rootNode.querySelectorAll(selector).forEach((node) => observer.observe(node));

      if (kind === "game") gameObserver = observer;
      if (kind === "sound") soundObserver = observer;
    }

    function toAbsolute(base, path) {
      if (!path) return "";
      try {
        return new URL(path, base).href;
      } catch {
        return "";
      }
    }

    async function fetchJson(url, timeoutMs = 25000) {
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), timeoutMs);
      try {
        const res = await fetch(url, { cache: "no-store", signal: controller.signal });
        if (!res.ok) return null;
        return await res.json();
      } catch {
        return null;
      } finally {
        clearTimeout(timer);
      }
    }

    function mapSeleniteGames(feed) {
      if (!Array.isArray(feed)) return [];
      return feed
        .filter((item) => item && item.name && item.directory)
        .map((item) => {
          const dir = String(item.directory).replace(/^\/+/, "");
          const link = toAbsolute("https://selenite-copy.pages.dev/", dir + "/index.html");
          const icon = toAbsolute("https://selenite-copy.pages.dev/", dir + "/" + (item.image || "icon.png"));
          return {
            id: 0,
            slug: slugify(item.name),
            name: item.name,
            sourcePage: link,
            embedUrl: link,
            fileUrl: "",
            icon
          };
        });
    }

    function map1kh0Games(feed) {
      if (!Array.isArray(feed)) return [];
      return feed
        .filter((item) => item && item.title && item.link)
        .map((item) => ({
          id: 0,
          slug: slugify(item.title),
          name: item.title,
          sourcePage: toAbsolute("https://1kh0.github.io/", item.link),
          embedUrl: toAbsolute("https://1kh0.github.io/", item.link),
          fileUrl: "",
          icon: toAbsolute("https://1kh0.github.io/", item.imgSrc || "")
        }));
    }

    async function loadExternalGames() {
      gamesSearch.placeholder = "Loading games...";
      gamesMeta.textContent = "Fetching from both sources...";

      const [seleniteRaw, kh0Raw] = await Promise.all([
        fetchJson(EXTERNAL_GAME_FEEDS[0].url),
        fetchJson(EXTERNAL_GAME_FEEDS[1].url)
      ]);

      const merged = [
        ...mapSeleniteGames(seleniteRaw),
        ...map1kh0Games(kh0Raw)
      ];

      allGames = uniqueGames(merged);
      applyGamesFilter();

      gamesSearch.placeholder = `Search games... (${allGames.length})`;
    }

    function getFallbackGameIcon(game) {
      const target = game.sourcePage || game.embedUrl || "";
      if (!target) return "";
      return "https://www.google.com/s2/favicons?sz=256&domain_url=" + encodeURIComponent(target);
    }

    function renderGames(list) {
      gameGrid.innerHTML = "";
      const fragment = document.createDocumentFragment();

      list.forEach((game) => {
        const button = document.createElement("button");
        button.type = "button";
        button.className = "game-card";
        button.title = game.name;
        button.setAttribute("aria-label", game.name);

        const image = document.createElement("img");
        const fallbackIcon = getFallbackGameIcon(game);
        image.src = game.icon || fallbackIcon;
        image.alt = game.name;
        image.loading = "lazy";
        image.decoding = "async";
        image.referrerPolicy = "no-referrer";
        image.addEventListener("error", () => {
          if (fallbackIcon && image.src !== fallbackIcon) {
            image.src = fallbackIcon;
          }
        });

        const name = document.createElement("div");
        name.className = "game-name";
        name.textContent = game.name;

        button.appendChild(image);
        button.appendChild(name);
        button.addEventListener("click", () => openGame(game));

        fragment.appendChild(button);
      });

      gameGrid.appendChild(fragment);
      wireObserver(gamesPanel, ".game-card", "game");
    }

    function renderSounds(list) {
      soundGrid.innerHTML = "";
      const fragment = document.createDocumentFragment();

      const colors = [
        { main: "#ff5f5f", shadow: "#c44545" },
        { main: "#5fafff", shadow: "#4585c4" },
        { main: "#5fff7d", shadow: "#45c45e" },
        { main: "#ffdf5f", shadow: "#c4ab45" },
        { main: "#af5fff", shadow: "#8045c4" }
      ];

      list.forEach((sound, index) => {
        const button = document.createElement("button");
        button.type = "button";
        button.className = "sound-btn";
        button.setAttribute("aria-label", sound.name || "sound");

        const color = colors[index % colors.length];
        button.style.backgroundColor = color.main;
        button.style.boxShadow = "0 8px 0 " + color.shadow + ", 0 15px 20px rgba(0,0,0,0.12)";
        button.innerHTML = '<span class="btn-label">' + (sound.name || "sound") + "</span>";

        button.addEventListener("click", () => playSound(sound.url));
        fragment.appendChild(button);
      });

      soundGrid.appendChild(fragment);
      wireObserver(soundsPanel, ".sound-btn", "sound");
    }

    function applyGamesFilter() {
      const query = norm(gamesSearch.value);
      const filtered = query ? allGames.filter((game) => norm(game.name).includes(query)) : allGames;
      gamesMeta.textContent = filtered.length + " / " + allGames.length + " games";
      renderGames(filtered);
      gamesPanel.scrollTop = 0;
    }

    function applySoundsFilter() {
      const query = norm(soundsSearch.value);
      const filtered = query ? allSounds.filter((sound) => norm(sound.name).includes(query)) : allSounds;
      renderSounds(filtered);
      soundsPanel.scrollTop = 0;
    }

    function showStatus(text) {
      gameStatus.textContent = text;
      gameStatus.classList.remove("hide");
    }

    function hideStatus() {
      gameStatus.classList.add("hide");
    }

    function getPlayer(url) {
      if (!players.has(url)) {
        const audio = new Audio(url);
        audio.preload = "none";
        players.set(url, audio);
      }
      return players.get(url);
    }

    function playSound(url) {
      if (!url) return;
      const audio = getPlayer(url);
      audio.currentTime = 0;
      audio.play().catch(() => {});
    }

    async function tryFrameLoad(url, token) {
      return await new Promise((resolve) => {
        let done = false;

        const finish = (ok) => {
          if (done) return;
          done = true;
          frame.onload = null;
          frame.onerror = null;
          clearTimeout(timer);
          resolve(ok);
        };

        const timer = setTimeout(() => finish(false), 10000);

        frame.onload = () => {
          if (token !== gameOpenToken) return finish(false);

          try {
            const href = frame.contentWindow && frame.contentWindow.location ? frame.contentWindow.location.href : "";
            if (href === "about:blank" || href.startsWith("chrome-error://") || href.startsWith("edge-error://")) {
              return finish(false);
            }
          } catch {
            // Cross-origin loaded. Treat as success.
          }

          finish(true);
        };

        frame.onerror = () => finish(false);
        frame.src = url;
      });
    }

    async function openGame(game) {
      const token = ++gameOpenToken;

      overlay.style.display = "block";
      showStatus("loading...");
      frame.src = "about:blank";

      const attempts = [game.embedUrl, game.sourcePage].filter(Boolean).filter((v, i, arr) => arr.indexOf(v) === i);

      for (const candidate of attempts) {
        if (token !== gameOpenToken) return;
        const ok = await tryFrameLoad(candidate, token);
        if (token !== gameOpenToken) return;
        if (ok) {
          hideStatus();
          return;
        }
      }

      showStatus("blocked in iframe");
    }

    function closeGame() {
      gameOpenToken += 1;
      overlay.style.display = "none";
      frame.src = "about:blank";
      hideStatus();
      setView("games");
    }

    backHomeBtn.addEventListener("click", closeGame);

    fullscreenBtn.addEventListener("click", () => {
      if (document.fullscreenElement) {
        document.exitFullscreen().catch(() => {});
      } else {
        overlay.requestFullscreen().catch(() => {});
      }
    });

    gamesSearch.addEventListener("input", applyGamesFilter);
    soundsSearch.addEventListener("input", applySoundsFilter);

    applyGamesFilter();
    applySoundsFilter();
    loadExternalGames();
  </script>
</body>
</html>
